---
title: "Boğaziçi University"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### IE 423 - Project Part-1

#### 2023-11-02

###### Nergiz Selin Angın - 2018402117

###### İlayda Küçükafacan - 2018402120

###### Ege Tuna Diken - 2020402282

<br>

##### Introduction 
The project focused on analyzing stock data for six diverse companies: Akbank, Aygaz, Banvit, Coca Cola, Şişecam Group, and Yapi Kredi. Through visual representation using box-plots, monthly stock performances were assessed, with two methods adopted to identify outliers. The first method identified numerous outliers, while the refined second method highlighted 21 specific outlier months. Subsequently, the research incorporated Google Trends data, observing the online popularity trajectory of the companies, such as Akbank and Aygaz. This data was juxtaposed with stock performances to discern potential correlations. The findings suggest a possible correlation between search volume of related keywords and stock prices.
<br>
#### 1. Library Loading

```{r message=FALSE, warning=FALSE, paged.print=FALSE}
library(ggplot2) 
library(lubridate) 
library(dplyr) 
library(gtrendsR) 
```
<br>

#### 2. Data Import
```{r}
file_path <- "/Users/selinangin/Desktop/IE 423/Project Part 1/all_ticks_long.csv.gz"
my_data <- read.csv(gzfile(file_path), header = TRUE)
```
<br>

#### 3. Selecting Six Stocks to Anlayze
```{r echo=TRUE, warning=FALSE, results = 'hide'}
# Check the first few rows of the data 
head(my_data)
# Get unique short_name values
unique_names <- unique(my_data$short_name)
# Display at least the first 200 unique short_names 
head(unique_names, 200)
# List of companies to check
companies <- c("AKBNK", "AYGAZ", "BANVT", "CCOLA", "SISE", "YKBNK")
# Convert the timestamp to a date-time object
my_data$timestamp <- as.POSIXct(my_data$timestamp, format="%Y- %m-%dT%H:%M:%SZ")
# Extract year and month from the timestamp 
my_data$year_month <- format(my_data$timestamp, "%Y-%m")
filtered_data <- subset(my_data, short_name %in% companies)
```
<br>
Akbank, Aygaz, Banvit, Coca Cola, Şişecam Group, and Yapi Kredi have been meticulously selected for the analysis, representing a diverse array of sectors including the financial, energy, food, beverage, industrial, and again, financial sectors respectively. 
<br>
<br>

#### 4. Monthly Box-Plots of the Selected Six Stocks
```{r}
# Generate separate boxplots for each company using facet_wrap 
ggplot(filtered_data, aes(x=year_month, y=price)) +
geom_boxplot(outlier.color="red", outlier.shape=16, outlier.size=2) + theme_minimal() +
theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 5)) +theme(axis.text.y = element_text( size = 5))+ facet_wrap(~ short_name, scales="free_y", ncol=1) + labs(title="Monthly Stock Prices by Company")

```
<br>

#### 5. Outliers of the Data  
##### 5.1. First Approach

```{r}
# Calculate outliers using IQR for each company and month 
outliers_data <- filtered_data %>%
group_by(short_name, year_month) %>% mutate(Q1 = quantile(price, 0.25),
Q3 = quantile(price, 0.75),
IQR = Q3 - Q1,
lower_bound = Q1 - 1.5 * IQR, upper_bound = Q3 + 1.5 * IQR) %>%
filter(price < lower_bound | price > upper_bound) %>% ungroup()
print(outliers_data)
```
<br>
The initial approach produced a massive set of 5499 outlier rows through a row-by-row analysis, which ultimately proved inefficient. To address this inefficiency, a second method is implemented. It centers around calculating the monthly means. This approach streamlines the process, allowing us to identify outliers based on these monthly averages, which provides a more concise and effective means of analysis.
<br>
<br>

##### 5.2. Second Approach

```{r}
# Calculate monthly means for the selected companies 
monthly_means <- filtered_data %>%
group_by(short_name, year_month) %>% summarize(monthly_mean = mean(price), .groups = "drop")
# Add a 'year' column to the monthly_means data 
monthly_means$year <- as.integer(format(as.Date(monthly_means$year_month, format = "%Y- %m"), "%Y"))
# Compute the annual statistics for each company 
annual_stats <- monthly_means %>%
group_by(short_name, year) %>% summarise(annual_mean = mean(monthly_mean),
Q1 = quantile(monthly_mean, 0.25),
Q3 = quantile(monthly_mean, 0.75),
IQR = Q3 - Q1,
lower_bound = annual_mean - 1.5 * IQR, upper_bound = annual_mean + 1.5 * IQR, .groups = "drop")
# Determine outlier months for each company and year based on the computed bounds
outlier_months <- monthly_means %>%
left_join(annual_stats, by = c("short_name", "year")) %>%
filter(monthly_mean < lower_bound | monthly_mean > upper_bound) %>%
select(short_name, year_month, monthly_mean)
print(outlier_months, n=nrow(outlier_months))

```
<br>
Using the second method, the table above successfully highlights 21 months that have been identified as outliers.
<br>

Displayed below are the plots representing the monthly average values for each company. These visual representations facilitate an easy examination of outlier months on a company-by-company basis, ensuring a comprehensive understanding of the data.
<br>

```{r message=FALSE, warning=FALSE, paged.print=FALSE}
ggplot(monthly_means, aes(x=year_month, y=monthly_mean)) + geom_line(aes(color=short_name), size=1) + geom_point(aes(color=short_name), size=1) + theme_minimal() + theme(axis.text.x = element_text(angle = 45, hjust = 1,size=5)) + theme(axis.text.y = element_text( size = 5)) + facet_wrap(~ short_name, scales="free_y", ncol=1) + labs(title="Monthly Average Stock Prices by Company", y="Average
Price")
```


#### 6. Insights with Google Trends Data 

<br>
##### 6.1. Akbank
```{r}
# Fetching Google Trends data for "Akbank" for the given time frame in Turkey
gtrends_result <- gtrends("Akbank", geo = "TR", time = "2012-01-01 2023-01-01")
names(gtrends_result)
```
The gtrends() function is a powerful tool for extracting Google Trends data, and it generates several data frames, each capturing different facets of the search term’s online popularity. When exploring the search term "Akbank," this function provides us with "Interest Over Time," illustrating the term's popularity trends within a designated time frame; "Interest by Country," mapping out the search term’s global appeal; "Interest by Region," offering a detailed look at its popularity within specific regions of a country; "Interest by DMA" (Designated Market Area), which is particularly pertinent for analyses within the U.S.; "Interest by City," narrowing down the popularity to city-level data; and "Related Topics," showcasing topics associated with "Akbank." For the purpose of our report, we are channeling our focus primarily on the "Interest Over Time" data frame, as it directly aligns with our goal to dissect and understand the chronological fluctuations in the popularity of "Akbank".


```{r}
akbank_trends <- gtrends_result$interest_over_time
# Akbank google trends plot 
ggplot(data = akbank_trends) +
geom_line(aes(x = date, y = hits), color = "blue", size = 1) + labs(title = "Google Trends Search Volume for 'Akbank'", x = "Date",  y = "Search Volume") +
theme_minimal()

monthly_means$year_month <- as.Date(paste0(monthly_means$year_month, "-01"), format = "%Y-%m- %d")
akbank_stock_data <- monthly_means[monthly_means$short_name == "AKBNK", ]
akbank_trends$date <- as.Date(paste0(akbank_trends$date, "-01"), format = "%Y-%m-%d")

# Merge the data frames
merged_data <- merge(akbank_trends, akbank_stock_data, by.x = "date", by.y = "year_month", all = TRUE)
filtered_data <- merged_data[!is.na(merged_data$short_name), ]

# Create a line plot for hits (Google Trends) and monthly_mean (Stock data)
ggplot(data = filtered_data) +
  geom_line(aes(x = date, y = hits, color = "Google Trends"), size = 1) +
  geom_line(aes(x = date, y = monthly_mean, color = "Stock Data"), size = 1) +
  labs(title = "Google Trends vs. Stock Data for 'Akbank'", x = "Date",
       y = "Value") +
  scale_color_manual(values = c("Google Trends" = "blue", "Stock Data" =
                                  "red")) + theme_minimal()
#*****
diff_data <- c(diff(filtered_data$hits),0)
filtered_data$hits<-diff_data
cor(diff_data, filtered_data$monthly_mean)
decopm_data<- decompose(filtered_data$hits,type="additive")


ccf(diff_data, filtered_data$monthly_mean, lag.max = 10)
kendall_corr <- cor(filtered_data$hits, filtered_data$monthly_mean, method = "kendall")
pearson_corr <- cor(filtered_data$hits, filtered_data$monthly_mean, method = "pearson")
library(ggcorrplot)
corr_data<-data.frame(c(filtered_data$hits,filtered_data$monthly_mean ))
length(filtered_data$hits)
length(filtered_data$monthly_mean)
ggcorrplot(corr_data, 
           hc.order = TRUE, 
           type = "lower",
           lab = TRUE)
```


##### 6.2. Aygaz
```{r}
# Fetching Google Trends data for "Aygaz" for the given timeframe in Turkey
gtrends_result2 <- gtrends("Aygaz", geo = "TR", time = "2012-01-01 2023-01-01")


aygaz_trends <- gtrends_result2$interest_over_time

# Aygaz google trends plot 
ggplot(data = aygaz_trends) +
  geom_line(aes(x = date, y = hits), color = "blue", size = 1) + labs(title = "Google Trends Search Volume for 'Aygaz'", x = "Date",    y = "Search Volume") +
  theme_minimal()

aygaz_trends <- gtrends_result2$interest_over_time

# Aygaz google trends plot 
ggplot(data = aygaz_trends) +
  geom_line(aes(x = date, y = hits), color = "blue", size = 1) + labs(title = "Google Trends Search Volume for 'Aygaz'", x = "Date",    y = "Search Volume") +
  theme_minimal()

monthly_means$year_month <- as.Date(paste0(monthly_means$year_month, "-01"), format = "%Y-%m- %d")
aygaz_stock_data <- monthly_means[monthly_means$short_name == "AYGAZ", ]
aygaz_trends$date <- as.Date(paste0(aygaz_trends$date, "-01"), format = "%Y-%m-%d")


# Merge the data frames
merged_data <- merge(aygaz_trends, aygaz_stock_data, by.x = "date", by.y = "year_month", all = TRUE)
filtered_data <- merged_data[!is.na(merged_data$short_name), ]

# Create a line plot for hits (Google Trends) and monthly_mean (Stock data)
ggplot(data = filtered_data) +
  geom_line(aes(x = date, y = hits, color = "Google Trends"), size = 1) +
  geom_line(aes(x = date, y = monthly_mean, color = "Stock Data"), size = 1) +
  labs(title = "Google Trends vs. Stock Data for 'Aygaz'", x = "Date",
       y = "Value") +
  scale_color_manual(values = c("Google Trends" = "blue", "Stock Data" =
                                  "red")) + theme_minimal()

```

##### 6.3. Banvit
```{r}
# This will fetch Google Trends data for "Banvit" for the given timeframe in Turkey
gtrends_result3 <- gtrends("Banvit", geo = "TR", time = "2012-01-01 2023-01-01")

# This section is for the interest over time only.
banvit_trends <- gtrends_result3$interest_over_time
# Banvit Google Trends plot
ggplot(data = banvit_trends) +
  geom_line(aes(x = date, y = hits), color = "blue", size = 1) + labs(title = "Google Trends Search Volume for 'Banvit'",
                                                                      x = "Date",
                                                                      y = "Search Volume") +
  theme_minimal()

monthly_means$year_month <- as.Date(paste0(monthly_means$year_month, "-01"), format = "%Y-%m-%d")
banvit_stock_data <- monthly_means[monthly_means$short_name == "BANVT", ]
banvit_trends$date <- as.Date(paste0(banvit_trends$date, "-01"), format = "%Y-%m-%d")

# Merge the data frames
merged_data <- merge(banvit_trends, banvit_stock_data, by.x = "date", by.y = "year_month", all = TRUE)
filtered_data <- merged_data[!is.na(merged_data$short_name), ]

library(ggplot2)
# Create a line plot for hits (Google Trends) and monthly_mean (Stock data)
ggplot(data = filtered_data) +
  geom_line(aes(x = date, y = hits, color = "Google Trends"), size = 1) +
  geom_line(aes(x = date, y = monthly_mean, color = "Stock Data"), size = 1) +
  labs(title = "Google Trends vs. Stock Data for 'Banvit'", x = "Date",
       y = "Value") +
  scale_color_manual(values = c("Google Trends" = "blue", "Stock Data" =
                                  "red")) + theme_minimal()

```

##### 6.4. Coca Cola
```{r}
# This will fetch Google Trends data for "CCola" for the given timeframe in Turkey
gtrends_result4 <- gtrends("CCola", geo = "TR", time = "2012-01-01 2023-01-01")

# This section is for the interest over time only.
ccola_trends <- gtrends_result4$interest_over_time
# CCola Google Trends plot
ggplot(data = ccola_trends) +
  geom_line(aes(x = date, y = hits), color = "blue", size = 1) + labs(title = "Google Trends Search Volume for 'CCola'",
                                                                      x = "Date",
                                                                      y = "Search Volume") +
  theme_minimal()

monthly_means$year_month <- as.Date(paste0(monthly_means$year_month, "-01"), format = "%Y-%m-%d")
ccola_stock_data <- monthly_means[monthly_means$short_name == "CCOLA", ]
ccola_trends$date <- as.Date(paste0(ccola_trends$date, "-01"), format = "%Y-%m-%d")

# Merge the data frames
merged_data <- merge(ccola_trends, ccola_stock_data, by.x = "date", by.y = "year_month", all = TRUE)
filtered_data <- merged_data[!is.na(merged_data$short_name), ]

library(ggplot2)
# Create a line plot for hits (Google Trends) and monthly_mean (Stock data)
ggplot(data = filtered_data) +
  geom_line(aes(x = date, y = hits, color = "Google Trends"), size = 1) +
  geom_line(aes(x = date, y = monthly_mean, color = "Stock Data"), size = 1) +
  labs(title = "Google Trends vs. Stock Data for 'CCola'", x = "Date",
       y = "Value") +
  scale_color_manual(values = c("Google Trends" = "blue", "Stock Data" =
                                  "red")) + theme_minimal()
```



##### 6.5. Şişecam Group
```{r}

# This will fetch Google Trends data for "Sise" for the given timeframe in Turkey
gtrends_result5 <- gtrends("Sise", geo = "TR", time = "2012-01-01 2023-01-01")

# This section is for the interest over time only.
sise_trends <- gtrends_result5$interest_over_time
# Sise Google Trends plot
ggplot(data = sise_trends) +
  geom_line(aes(x = date, y = hits), color = "blue", size = 1) + labs(title = "Google Trends Search Volume for 'Sise'",
                                                                      x = "Date",
                                                                      y = "Search Volume") +
  theme_minimal()

monthly_means$year_month <- as.Date(paste0(monthly_means$year_month, "-01"), format = "%Y-%m-%d")
sise_stock_data <- monthly_means[monthly_means$short_name == "SISE", ]
sise_trends$date <- as.Date(paste0(sise_trends$date, "-01"), format = "%Y-%m-%d")

# Merge the data frames
merged_data <- merge(sise_trends, sise_stock_data, by.x = "date", by.y = "year_month", all = TRUE)
filtered_data <- merged_data[!is.na(merged_data$short_name), ]

library(ggplot2)
# Create a line plot for hits (Google Trends) and monthly_mean (Stock data)
ggplot(data = filtered_data) +
  geom_line(aes(x = date, y = hits, color = "Google Trends"), size = 1) +
  geom_line(aes(x = date, y = monthly_mean, color = "Stock Data"), size = 1) +
  labs(title = "Google Trends vs. Stock Data for 'Sise'", x = "Date",
       y = "Value") +
  scale_color_manual(values = c("Google Trends" = "blue", "Stock Data" =
                                  "red")) + theme_minimal()

```




##### 6.6. Yapi Kredi 
```{r}
# This will fetch Google Trends data for "Ykbnk" for the given timeframe in Turkey
gtrends_result6 <- gtrends("Ykbnk", geo = "TR", time = "2012-01-01 2023-01-01")

# This section is for the interest over time only.
ykbnk_trends <- gtrends_result6$interest_over_time
# Ykbnk Google Trends plot
ggplot(data = ykbnk_trends) +
  geom_line(aes(x = date, y = hits), color = "blue", size = 1) + labs(title = "Google Trends Search Volume for 'Ykbnk'",
                                                                      x = "Date",
                                                                      y = "Search Volume") +
  theme_minimal()

monthly_means$year_month <- as.Date(paste0(monthly_means$year_month, "-01"), format = "%Y-%m-%d")
ykbnk_stock_data <- monthly_means[monthly_means$short_name == "YKBNK", ]
ykbnk_trends$date <- as.Date(paste0(ykbnk_trends$date, "-01"), format = "%Y-%m-%d")

# Merge the data frames
merged_data <- merge(ykbnk_trends, ykbnk_stock_data, by.x = "date", by.y = "year_month", all = TRUE)
filtered_data <- merged_data[!is.na(merged_data$short_name), ]

library(ggplot2)
# Create a line plot for hits (Google Trends) and monthly_mean (Stock data)
ggplot(data = filtered_data) +
  geom_line(aes(x = date, y = hits, color = "Google Trends"), size = 1) +
  geom_line(aes(x = date, y = monthly_mean, color = "Stock Data"), size = 1) +
  labs(title = "Google Trends vs. Stock Data for 'Ykbnk'", x = "Date",
       y = "Value") +
  scale_color_manual(values = c("Google Trends" = "blue", "Stock Data" =
                                  "red")) + theme_minimal()

```




